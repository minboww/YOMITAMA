<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ヨミタマ</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
  <style>
    /* --- CSS --- */
    :root {
        --font-serif: 'Sawarabi Mincho', "游明朝", YuMincho, serif;
        --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --bg-color: #EEDAB9; 
        --base-text-color: #3a3a3a;
        --primary-color: #556b2f;
        --secondary-color: #b22222;
        --white-color: #ffffff;
        --light-gray-color: #e0e0e0;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --overlay-color: rgba(0, 0, 0, 0.6);
    }
    html, body { height: 100%; margin: 0; padding: 0; font-family: var(--font-serif); background-color: var(--bg-color); color: var(--base-text-color); }
    #map { width: 100%; height: 100%; background-color: var(--bg-color); }
    .float-button { position: fixed; bottom: 30px; width: 80px; height: 80px; color: var(--white-color); border-radius: 50%; border: 2px solid var(--white-color); box-shadow: 0 4px 12px var(--shadow-color); font-size: 26px; font-weight: bold; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; z-index: 1000; }
    .float-button:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15); }
    #kigoButton { left: 20px; background-color: var(--secondary-color); }
    .haiku-marker { cursor: pointer; transition: transform 0.2s ease-out; position: relative; }
    .haiku-marker:hover { transform: scale(1.05); z-index: 1000 !important; }
    .haiku-marker-body {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 255, 255, 0.9);
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
        border: 1px solid rgba(85, 107, 47, 0.7);
        border-radius: 8px;
        padding: 10px 4px 10px 0;
        box-shadow: 0 3px 8px var(--shadow-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        transition: padding 0.3s ease-in-out;
    }
    .leaflet-div-icon { background: none; border: none; }
    .haiku-marker-body::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 10px solid rgba(85, 107, 47, 0.7); }
    .haiku-tategaki { writing-mode: vertical-rl; text-orientation: mixed; white-space: nowrap; font-size: 16px; font-weight: bold; color: var(--base-text-color); letter-spacing: 0.1em; line-height: 1.7; transition: all 0.3s ease-in-out; }
    .naka-shimo-wrapper { display: inline-block; max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out 0.1s; margin: 0; padding: 0; }
    .kami, .naka, .shimo { display: inline-block; }
    .haiku-actions {
        display: none;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 8px;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out 0.1s;
    }
    .like-button { background-color: #ffefff; border: 1px solid #e1bee7; color: #8e24aa; padding: 5px 10px; border-radius: 15px; cursor: pointer; font-family: var(--font-sans); font-size: 14px; transition: background-color 0.2s; white-space: nowrap; }
    .like-button.liked, .like-button:disabled { background-color: e1bee7; color: white; cursor: not-allowed; }
    .like-count { font-family: var(--font-sans); font-weight: bold; font-size: 16px; color: #6a6a6a; }
    .haiku-marker.expanded .haiku-marker-body {         padding: 10px 4px 10px 0; }
    .haiku-marker.expanded .naka-shimo-wrapper { max-height: 20em; opacity: 1; }
    .haiku-marker.expanded .haiku-actions { max-height: 50px; opacity: 1; }
    
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-color); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 0 15px; box-sizing: border-box; }
    .modal-overlay.is-visible { opacity: 1; visibility: visible; }
    
    .modal-content { 
        background-color: var(--bg-color); 
        padding: 30px; 
        border-radius: 12px; 
        width: 100%; 
        max-width: 400px; 
        text-align: center; 
        box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
        transform: translateY(20px); 
        transition: transform 0.3s ease-out; 
        
        display: flex; 
        flex-direction: column;
        max-height: 80vh; 
        overflow: hidden; 
    }
    .modal-overlay.is-visible .modal-content { transform: translateY(0); }
    .modal-content h2 { 
        margin-top: 0; 
        font-size: 24px; 
        color: var(--base-text-color); 
        flex-shrink: 0; 
    }

    #kigoListContainer { 
        text-align: left; 
        font-family: var(--font-sans); 
        list-style-position: inside; 
        
        overflow-y: auto; 
        flex: 1; 
        min-height: 0; 

        padding-right: 15px; 
    }
    
    #kigoListContainer h3 {
        font-family: var(--font-serif);
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 5px;
        margin-top: 20px;
        margin-bottom: 10px;
    }
    #kigoListContainer h4 {
        font-family: var(--font-serif);
        color: var(--base-text-color);
        margin-top: 15px;
        margin-bottom: 5px;
    }
    #kigoListContainer p {
        font-size: 14px;
        line-height: 1.6;
        margin: 0 0 10px 0;
        font-family: var(--font-sans);
    }
    #kigoListContainer hr {
        border: none;
        border-top: 1px solid var(--light-gray-color);
        margin: 20px 0;
    }

    .haiku-input-container { display: flex; justify-content: center; gap: 15px; margin: 25px 0; }
    .haiku-input-area { writing-mode: vertical-rl; text-orientation: upright; height: 160px; width: 45px; padding: 12px; font-size: 18px; font-family: inherit; border: 1px solid var(--light-gray-color); border-radius: 6px; resize: none; white-space: pre; overflow: hidden; background-color: var(--white-color); transition: border-color 0.2s, box-shadow 0.2s; }
    .haiku-input-area:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(85, 107, 47, 0.2); }
    
    .modal-buttons { 
        margin-top: 25px; 
        flex-shrink: 0;
    }
    .modal-buttons button { padding: 12px 24px; font-size: 16px; border-radius: 8px; cursor: pointer; border: none; font-family: var(--font-sans); font-weight: bold; transition: opacity 0.2s; }
    .submit-haiku-button { background-color: var(--primary-color); color: white; margin-right: 10px; }
    .cancel-button { background-color: #d0d0d0; color: #555; }
</style>
</head>
<body>
    <div id="map"></div>
    <div class="float-button" id="kigoButton">季語</div>
    <div class="modal-overlay" id="haikuModal"><div class="modal-content"><h2 id="haikuModalTitle">一句、詠む</h2><div class="haiku-input-container"><textarea class="haiku-input-area" id="shimoNoKuInput" placeholder="下 の 句" maxlength="10"></textarea><textarea class="haiku-input-area" id="nakaNoKuInput" placeholder="中 の 句" maxlength="10"></textarea><textarea class="haiku-input-area" id="kamiNoKuInput" placeholder="上 の 句" maxlength="10"></textarea></div><div class="modal-buttons"><button type="button" class="submit-haiku-button" id="submitHaiku">投稿</button><button type="button" class="cancel-button" id="cancelHaiku">取消</button></div></div></div>
    <div class="modal-overlay" id="kigoModal"><div class="modal-content"><h2 id="kigoModalTitle">今の季語</h2><div id="kigoListContainer"></div><div class="modal-buttons"><button type="button" class="cancel-button" id="closeKigoModal">閉じる</button></div></div></div>

    <script>
        // --- ★ Firebase（データベース）設定 ---
        const firebaseConfig = { apiKey: "AIzaSyAHJZka9pXIl4LUo_Xtt1S7aINMJVDVDb0", authDomain: "yomitama-6cb84.firebaseapp.com", projectId: "yomitama-6cb84", storageBucket: "yomitama-6cb84.appspot.com", messagingSenderId: "812764737990", appId: "1:812764737990:web:a88d864b7e4c130c3542c7" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    
    <script>
        // --- スポット設定 ---
        const spotLocations = {
            "a": { pos: [ 1371, 1349 ], name: "三檪庵で" }, 
            "b":    { pos: [ 1560, 2591 ], name: "ここで" }, 
            "c":        { pos: [ 1672, 3528 ], name: "ここで" } ,
             "d": { pos: [ 2470, 3434 ], name: "山道で" }, 
            "e":    { pos: [ 2740, 2996 ], name: "見晴台で" }, 
            "f":        { pos: [ 3000, 1769 ], name: "見晴台で" } ,
             "g": { pos: [ 2536, 1521 ], name: "芭蕉句碑で" }, 
            "h":    { pos: [ 2164, 1925 ], name
