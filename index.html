<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>ヨミタマ</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --font-serif: 'Sawarabi Mincho', "游明朝", YuMincho, serif;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --bg-color: #f7f6f2;
            --base-text-color: #3a3a3a;
            --primary-color: #556b2f;
            --secondary-color: #b22222;
            --tertiary-color: #4682b4;
            --white-color: #ffffff;
            --light-gray-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --overlay-color: rgba(0, 0, 0, 0.6);
        }
        html, body { height: 100%; margin: 0; padding: 0; font-family: var(--font-serif); background-color: var(--bg-color); color: var(--base-text-color); }
        #map { width: 100%; height: 100%; }
        .float-button { position: fixed; bottom: 30px; width: 80px; height: 80px; color: var(--white-color); border-radius: 50%; border: 2px solid var(--white-color); box-shadow: 0 4px 12px var(--shadow-color); font-size: 26px; font-weight: bold; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; z-index: 1000; }
        .float-button:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15); }
        #yomuButton { right: 20px; background-color: var(--primary-color); }
        #kigoButton { left: 20px; background-color: var(--secondary-color); }
        #listButton { right: 20px; bottom: 120px; width: 60px; height: 60px; font-size: 20px; background-color: var(--tertiary-color); }
        
        .haiku-marker { cursor: pointer; transition: transform 0.2s ease-out; position: relative; }
        .haiku-marker:hover { transform: scale(1.05); z-index: 1000 !important; }
        .haiku-marker-body { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background-color: rgba(255, 255, 255, 0.9); -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px); border: 1px solid rgba(85, 107, 47, 0.7); border-radius: 8px; padding: 10px 8px; box-shadow: 0 3px 8px var(--shadow-color); display: flex; align-items: flex-start; transition: padding 0.3s ease-in-out; }
        .leaflet-div-icon { background: none; border: none; }
        .haiku-marker-body::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 10px solid rgba(85, 107, 47, 0.7); }
        .haiku-tategaki { writing-mode: vertical-rl; text-orientation: mixed; white-space: nowrap; font-size: 16px; font-weight: bold; color: var(--base-text-color); letter-spacing: 0.1em; line-height: 1.7; transition: all 0.3s ease-in-out; }
        .naka-shimo-wrapper { display: inline-block; max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out 0.1s; margin: 0; padding: 0; }
        .kami, .naka, .shimo { display: inline-block; }
        .naka { margin-right: 0.8em; }
        .haiku-actions { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; margin-left: 10px; max-width: 0; opacity: 0; overflow: hidden; transition: max-width 0.3s ease-in-out, opacity 0.2s ease-in-out 0.1s; }
        .like-button { background-color: #ffefff; border: 1px solid #e1bee7; color: #8e24aa; padding: 5px 10px; border-radius: 15px; cursor: pointer; font-family: var(--font-sans); font-size: 14px; transition: background-color 0.2s; white-space: nowrap; }
        .like-button.liked, .like-button:disabled { background-color: #e1bee7; color: white; cursor: not-allowed; }
        .like-count { font-family: var(--font-sans); font-weight: bold; font-size: 16px; color: #6a6a6a; }
        .haiku-marker.expanded .haiku-marker-body { padding: 12px 15px; }
        .haiku-marker.expanded .naka-shimo-wrapper { max-height: 20em; opacity: 1; }
        .haiku-marker.expanded .haiku-actions { max-width: 100px; opacity: 1; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-color); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 0 15px; box-sizing: border-box; }
        .modal-overlay.is-visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-color); padding: 30px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); transform: translateY(20px); transition: transform 0.3s ease-out; }
        .modal-overlay.is-visible .modal-content { transform: translateY(0); }
        .modal-content h2 { margin-top: 0; font-size: 24px; color: var(--base-text-color); }
        #kigoListContainer { text-align: left; font-family: var(--font-sans); list-style-position: inside; }
        .haiku-input-container { display: flex; justify-content: center; gap: 15px; margin: 25px 0; }
        .haiku-input-area { writing-mode: vertical-rl; text-orientation: upright; height: 160px; width: 45px; padding: 12px; font-size: 18px; font-family: inherit; border: 1px solid var(--light-gray-color); border-radius: 6px; resize: none; white-space: pre; overflow: hidden; background-color: var(--white-color); transition: border-color 0.2s, box-shadow 0.2s; }
        .haiku-input-area:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(85, 107, 47, 0.2); }
        #haikuListContainer { max-height: 60vh; overflow-y: auto; text-align: left; margin-top: 20px; font-family: var(--font-sans); }
        .haiku-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid var(--light-gray-color); cursor: pointer; transition: background-color 0.2s; }
        .haiku-list-item:hover { background-color: #fffaf0; }
        .haiku-list-text { font-size: 16px; line-height: 1.5; }
        .haiku-list-distance { font-size: 14px; color: #777; white-space: nowrap; margin-left: 15px; }
        .modal-buttons { margin-top: 25px; }
        .modal-buttons button { padding: 12px 24px; font-size: 16px; border-radius: 8px; cursor: pointer; border: none; font-family: var(--font-sans); font-weight: bold; transition: opacity 0.2s; }
        .submit-haiku-button { background-color: var(--primary-color); color: white; margin-right: 10px; }
        .cancel-button { background-color: #d0d0d0; color: #555; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="float-button" id="kigoButton">季語</div>
    <div class="float-button" id="listButton">一覧</div>
    <div class="float-button" id="yomuButton">詠む</div>

    <div class="modal-overlay" id="haikuModal"><div class="modal-content"><h2>一句、詠む</h2><div class="haiku-input-container"><textarea class="haiku-input-area" id="shimoNoKuInput" placeholder="下 の 句" maxlength="10"></textarea><textarea class="haiku-input-area" id="nakaNoKuInput" placeholder="中 の 句" maxlength="10"></textarea><textarea class="haiku-input-area" id="kamiNoKuInput" placeholder="上 の 句" maxlength="10"></textarea></div><div class="modal-buttons"><button type="button" class="submit-haiku-button" id="submitHaiku">投稿</button><button type="button" class="cancel-button" id="cancelHaiku">取消</button></div></div></div>
    <div class="modal-overlay" id="kigoModal"><div class="modal-content"><h2 id="kigoModalTitle">今の季語</h2><div id="kigoListContainer"></div><div class="modal-buttons"><button type="button" class="cancel-button" id="closeKigoModal">閉じる</button></div></div></div>
    <div class="modal-overlay" id="listModal"><div class="modal-content"><h2>近くの句</h2><div id="haikuListContainer"></div><div class="modal-buttons"><button type="button" class="cancel-button" id="closeListModal">閉じる</button></div></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAHJZka9pXIl4LUo_Xtt1S7aINMJVDVDb0", authDomain: "yomitama-6cb84.firebaseapp.com", projectId: "yomitama-6cb84", storageBucket: "yomitama-6cb84.appspot.com", messagingSenderId: "812764737990", appId: "1:812764737990:web:a88d864b7e4c130c3542c7" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mapElement = document.getElementById('map');
            const yomuButton = document.getElementById('yomuButton');
            const kigoButton = document.getElementById('kigoButton');
            const listButton = document.getElementById('listButton');
            const haikuModal = document.getElementById('haikuModal');
            const kigoModal = document.getElementById('kigoModal');
            const listModal = document.getElementById('listModal');
            const kamiNoKuInput = document.getElementById('kamiNoKuInput');
            const nakaNoKuInput = document.getElementById('nakaNoKuInput');
            const shimoNoKuInput = document.getElementById('shimoNoKuInput');
            const submitHaikuButton = document.getElementById('submitHaiku');
            const cancelHaikuButton = document.getElementById('cancelHaiku');
            const closeKigoModalButton = document.getElementById('closeKigoModal');
            const closeListModalButton = document.getElementById('closeListModal');
            const haikuListContainer = document.getElementById('haikuListContainer');

            let currentUserPosition = null;
            let allHaikuData = [];
            let haikuMarkers = {};
            let expandedMarker = null;

            const openModal = (modal) => modal.classList.add('is-visible');
            const closeModal = (modal) => modal.classList.remove('is-visible');
            const clearHaikuInputs = () => { kamiNoKuInput.value = ""; nakaNoKuInput.value = ""; shimoNoKuInput.value = ""; };

            const map = L.map(mapElement, { zoomControl: false }).setView([35.6812, 139.7671], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' }).addTo(map);

            map.locate({setView: true, maxZoom: 16, watch: true});
            map.on('locationfound', (e) => { currentUserPosition = e.latlng; });
            map.on('locationerror', (e) => { alert("位置情報の取得に失敗しました。"); });
            
            const getLikedHaikuIds = () => { const ids = localStorage.getItem('yomitama_liked_ids'); return ids ? JSON.parse(ids) : []; };
            const addLikedHaikuId = (id) => { const ids = getLikedHaikuIds(); if (!ids.includes(id)) { ids.push(id); localStorage.setItem('yomitama_liked_ids', JSON.stringify(ids)); } };
            const isHaikuLiked = (id) => getLikedHaikuIds().includes(id);

            const getElementSize = (html, className) => {
                const el = document.createElement('div');
                el.style.position = 'absolute'; el.style.visibility = 'hidden'; el.style.left = '-9999px'; el.className = className; el.innerHTML = html;
                document.body.appendChild(el);
                const size = { width: el.offsetWidth, height: el.offsetHeight };
                document.body.removeChild(el);
                return size;
            };

            function addHaikuToMap(haikuData) {
                const { id, kami, naka, shimo, latlng, likes } = haikuData;
                
                const tailHeight = 10;
                const iconHtml = `<div class="haiku-marker-body"><div class="haiku-tategaki"><span class="kami">${kami}</span><span class="naka-shimo-wrapper"><span class="naka">${naka}</span><span class="shimo">${shimo}</span></span></div><div class="haiku-actions"><button class="like-button" data-id="${id}">いいね</button><span class="like-count">${likes}</span></div></div>`;

                const initialHtmlForSizing = `<div class="haiku-marker-body"><div class="haiku-tategaki"><span class="kami">${kami}</span></div></div>`;
                const contentSize = getElementSize(initialHtmlForSizing, '');

                const iconWidth = contentSize.width;
                const iconTotalHeight = contentSize.height + tailHeight;

                const haikuIcon = L.divIcon({
                    className: 'haiku-marker',
                    html: iconHtml,
                    iconSize: [iconWidth, iconTotalHeight],
                    iconAnchor: [iconWidth / 2, iconTotalHeight],
                });
                
                const marker = L.marker([latlng.lat, latlng.lng], {icon: haikuIcon}).addTo(map);
                marker.haikuId = id;
                haikuMarkers[id] = marker;

                marker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    if (expandedMarker && expandedMarker !== marker) {
                        expandedMarker.getElement().classList.remove('expanded');
                    }
                    const element = marker.getElement();
                    element.classList.toggle('expanded');
                    
                    if (element.classList.contains('expanded')) {
                        expandedMarker = marker;
                    } else {
                        expandedMarker = null;
                    }
                });

                marker.on('add', () => {
                    const el = marker.getElement();
                    // ★修正: いいねボタンが押せるように、マーカー内のクリックイベントが地図に伝播しないようにする
                    L.DomEvent.disableClickPropagation(el);

                    const likeButton = el.querySelector('.like-button');
                    const likeCountSpan = el.querySelector('.like-count');
                    
                    if (isHaikuLiked(id)) {
                        likeButton.classList.add('liked');
                        likeButton.disabled = true;
                        likeButton.textContent = '済';
                    }

                    likeButton.addEventListener('click', (e) => {
                        // stopPropagationは念のため残しておきます
                        L.DomEvent.stopPropagation(e);
                        if (isHaikuLiked(id)) return;

                        const docRef = db.collection("haiku").doc(id);
                        db.runTransaction((transaction) => {
                           return transaction.get(docRef).then((doc) => {
                               if (!doc.exists) { throw "Document does not exist!"; }
                               const newLikes = (doc.data().likes || 0) + 1;
                               transaction.update(docRef, { likes: newLikes });
                               return newLikes;
                           });
                        }).then((newLikes) => {
                            addLikedHaikuId(id);
                            likeCountSpan.textContent = newLikes;
                            likeButton.classList.add('liked');
                            likeButton.disabled = true;
                            likeButton.textContent = '済';
                        }).catch((error) => console.error("Transaction failed: ", error));
                    });
                });
            }
            
            map.on('click', () => {
                if (expandedMarker) {
                    expandedMarker.getElement().classList.remove('expanded');
                    expandedMarker = null;
                }
            });

            db.collection("haiku").orderBy("createdAt", "asc").onSnapshot((querySnapshot) => {
                querySnapshot.docChanges().forEach((change) => {
                    const doc = change.doc;
                    const data = doc.data();
                    const haikuData = { id: doc.id, kami: data.kami, naka: data.naka, shimo: data.shimo, latlng: data.latlng, likes: data.likes };
                    
                    if (change.type === "added") {
                        addHaikuToMap(haikuData);
                        allHaikuData.push(haikuData);
                    }
                    if (change.type === "modified") {
                        const marker = haikuMarkers[doc.id];
                        if (marker) {
                            const el = marker.getElement();
                            if (el) {
                                el.querySelector('.like-count').textContent = data.likes;
                            }
                        }
                        const index = allHaikuData.findIndex(h => h.id === doc.id);
                        if (index > -1) { allHaikuData[index].likes = data.likes; }
                    }
                });
            });

            submitHaikuButton.addEventListener('click', () => {
                const kamiNoKu = kamiNoKuInput.value.trim();
                const nakaNoKu = nakaNoKuInput.value.trim();
                const shimoNoKu = shimoNoKuInput.value.trim();
                if (!currentUserPosition || kamiNoKu === "" || nakaNoKu === "" || shimoNoKu === "") { alert("すべての句を入力し、現在地が取得できるのを待ってください。"); return; }
                db.collection("haiku").add({
                    kami: kamiNoKu, naka: nakaNoKu, shimo: shimoNoKu, latlng: { lat: currentUserPosition.lat, lng: currentUserPosition.lng }, likes: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => { closeModal(haikuModal); setTimeout(clearHaikuInputs, 300); }).catch((error) => { console.error("Error writing document: ", error); alert("投稿に失敗しました。"); });
            });
            
            listButton.addEventListener('click', () => {
                if (!currentUserPosition) { alert("現在地が特定できていません。"); return; }
                const sortedHaiku = allHaikuData.map(haiku => {
                    const haikuLatLng = L.latLng(haiku.latlng.lat, haiku.latlng.lng);
                    const distance = currentUserPosition.distanceTo(haikuLatLng);
                    return { ...haiku, distance };
                }).sort((a, b) => a.distance - b.distance);
                haikuListContainer.innerHTML = '';
                sortedHaiku.slice(0, 50).forEach(haiku => {
                    const item = document.createElement('div');
                    item.className = 'haiku-list-item';
                    item.dataset.id = haiku.id;
                    item.innerHTML = `<div class="haiku-list-text">${haiku.kami} ${haiku.naka} ${haiku.shimo}</div><div class="haiku-list-distance">約${Math.round(haiku.distance)}m</div>`;
                    item.addEventListener('click', () => {
                        const marker = haikuMarkers[haiku.id];
                        if (marker) {
                            closeModal(listModal);
                            map.setView(marker.getLatLng(), 16);
                            marker.fire('click');
                        }
                    });
                    haikuListContainer.appendChild(item);
                });
                openModal(listModal);
            });

            yomuButton.addEventListener('click', () => { if (!currentUserPosition) { alert("現在地が特定できていません。"); return; } openModal(haikuModal); });

            // ★修正: 季語ボタンの処理を実装
            kigoButton.addEventListener('click', () => {
                const kigoData = { 1: ["正月", "初詣", "寒椿"], 2: ["梅", "春一番", "立春"], 3: ["雛祭り", "蝶", "春分"], 4: ["花見", "桜", "燕"], 5: ["鯉のぼり", "新緑", "田植え"], 6: ["梅雨", "紫陽花", "蛍"], 7: ["七夕", "風鈴", "蝉"], 8: ["盆", "向日葵", "雷"], 9: ["月見", "鈴虫", "台風"], 10: ["紅葉", "秋祭り", "運動会"], 11: ["七五三", "木枯らし", "焚き火"], 12: ["クリスマス", "大晦日", "雪"] };
                const kigoModalTitle = document.getElementById('kigoModalTitle');
                const kigoListContainer = document.getElementById('kigoListContainer');
                const month = new Date().getMonth() + 1;

                kigoModalTitle.textContent = `${month}月の季語`;
                kigoListContainer.innerHTML = '';
                const kigoList = kigoData[month] || [];
                if (kigoList.length > 0) {
                    const ul = document.createElement('ul');
                    kigoList.forEach(kigo => {
                        const li = document.createElement('li');
                        li.textContent = kigo;
                        ul.appendChild(li);
                    });
                    kigoListContainer.appendChild(ul);
                } else {
                    kigoListContainer.textContent = '該当する季語がありません。';
                }
                openModal(kigoModal);
            });

            cancelHaikuButton.addEventListener('click', () => { closeModal(haikuModal); setTimeout(clearHaikuInputs, 300); });
            closeKigoModalButton.addEventListener('click', () => { closeModal(kigoModal); });
            closeListModalButton.addEventListener('click', () => { closeModal(listModal); });
            [haikuModal, kigoModal, listModal].forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) { closeModal(modal); if(modal === haikuModal) setTimeout(clearHaikuInputs, 300); } }); });
        });
    </script>
</body>
</html>
